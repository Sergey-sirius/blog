Title: Metro Math
Date: 2016-8-28 14:12
Tags: Washington, DC, Metro, WMATA, Math, Analysis, Data Science, Data
Category: math
Slug: metro-math
Summary: WMATA relatively recently released a new API. Let's see some things we can do with archived data.
Status: published
Authors: Keith Kelly

![Metro]({filename}images/metro.png)
*Image credit Washington Post*
[//]: # (https://www.washingtonpost.com/graphics/local/metro-closures/img/WMATAa10506-promo.jpg)


(
*Update 8/28/16 11pm*: the plots and code have been updated after reddit user /u/Grimace06 caught an oversight.
I had neglected to account for train directionality in computing headways and wait times.
)

For those unfamiliar, Metro is how the Washington Metropolitan Area Transit Authority ([WMATA](https://beta.wmata.com/)) is commonly referred to.
It is the transit authority for the Washington, DC region and operates Metrorail, Metrobus, and MetroAccess, the first of which is the topic of this post.
Back in mid-July [WMATA released a new API](http://www.wmata.com/about_metro/news/PressReleaseDetail.cfm?ReleaseID=6136) giving real-time train position information.
Prior to this, it was possible, though difficult, to estimate train positions with some heuristics as the people behind [demetrohero.com](http://dcmetrohero.com/) were doing rather successfullly.
I attempted something similar but never had much success.
The new train positions API made it much easier to get the train positions and also gave unique identifiers to the trains, allowing API users to more accurately follow a particular train through time.

Reddit user [/u/Stuck_In_the_Matrix](https://www.reddit.com/user/Stuck_In_the_Matrix) has kindly been [archiving the responses](http://files.pushshift.io/wmata/) of the train positions API queries online for people to download.
Given this archived data I thought it might be interesting to do some analysis on it.
This idea was inspired by Erik Bernhardsson's excellent blog entry [NYC subway math](https://erikbern.com/2016/04/04/nyc-subway-math.html), which used the MTA API to get some data to analyze waiting times.

### First things first...
Step one is usually (always) getting the data.
The WMATA data archive I mentioned above has a ton of files and many of them are related to the buses which I didn't need.
To facilitate downloading the data I wrote a [simple python script](TODO: link the script) using [requests](http://docs.python-requests.org/en/master/) and [BeautifulSoup](https://www.crummy.com/software/BeautifulSoup/).
Here's an example of the data that we get.


<div class="container-fluid" style="overflow: auto">
<table class="table table-bordered table-striped table-hover table-responsive">
  <thead>
    <tr>
      <th></th>
      <th>CarCount</th>
      <th>CircuitId</th>
      <th>DestinationStationCode</th>
      <th>DirectionNum</th>
      <th>LineCode</th>
      <th>SecondsAtLocation</th>
      <th>ServiceType</th>
      <th>TrainId</th>
      <th>retrieved_on</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6</td>
      <td>1140</td>
      <td>E01</td>
      <td>1</td>
      <td>YL</td>
      <td>0</td>
      <td>Normal</td>
      <td>218</td>
      <td>1472029202</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6</td>
      <td>2036</td>
      <td>C15</td>
      <td>2</td>
      <td>YL</td>
      <td>0</td>
      <td>Normal</td>
      <td>226</td>
      <td>1472029202</td>
    </tr>
    <tr>
      <th>2</th>
      <td>6</td>
      <td>2486</td>
      <td>N06</td>
      <td>2</td>
      <td>SV</td>
      <td>5</td>
      <td>Normal</td>
      <td>015</td>
      <td>1472029202</td>
    </tr>
    <tr>
      <th>3</th>
      <td>6</td>
      <td>2911</td>
      <td>G05</td>
      <td>1</td>
      <td>SV</td>
      <td>5</td>
      <td>Normal</td>
      <td>215</td>
      <td>1472029202</td>
    </tr>
    <tr>
      <th>4</th>
      <td>6</td>
      <td>3157</td>
      <td>G05</td>
      <td>1</td>
      <td>SV</td>
      <td>0</td>
      <td>Normal</td>
      <td>186</td>
      <td>1472029202</td>
    </tr>
  </tbody>
</table>
</div>


Unfortunately, the data did not have all the information that I wanted.
It's lacking whether or not the given train is at a station or a trip identifier for the train.
This meant that, as usual, I had to add data from other sources (another WMATA API in this case), to get the information I needed.
To get station info we can query the metro API and find out which circuits belong to stations.
By trip identifier I mean a unique identifier for a trip from start to end.
A red line train from Shady Grove to Glenmont could be one trip, but if that train turns around and starts going the other way, it's a new trip.
Trip identifiers can be generated by a combination of the unique train ID and its destination.
If a train ID and destination combination has not been seen, that's a new trip.
If a train ID has been seen, but the destination is now different, that's a new trip.

Finally I drop all rows of the dataframe where a train is not at a station and make a few other adjustments and get some nicer data.
Now it looks like something like this.


<div class="container-fluid" style="overflow: auto">
<table class="table table-bordered table-striped table-hover table-responsive">
	<thead>
		<tr>
      <th></th>
      <th>CarCount</th>
      <th>CircuitId</th>
      <th>DestinationStationCode</th>
      <th>DirectionNum</th>
      <th>LineCode</th>
      <th>SecondsAtLocation</th>
      <th>ServiceType</th>
      <th>TrainId</th>
      <th>retrieved_on</th>
      <th>Track</th>
      <th>SeqNum</th>
      <th>StationCode</th>
      <th>StartTime</th>
      <th>TripId</th>
      <th>DateTime</th>
      <th>Date</th>
      <th>Time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6</td>
      <td>2574</td>
      <td>J03</td>
      <td>2</td>
      <td>BL</td>
      <td>5</td>
      <td>Normal</td>
      <td>327</td>
      <td>1469175470</td>
      <td>2</td>
      <td>418</td>
      <td>G05</td>
      <td>2016-07-22 04:17:50</td>
      <td>2016-07-22_0</td>
      <td>2016-07-22 04:17:50</td>
      <td>2016-07-22</td>
      <td>04:17:50</td>
    </tr>
    <tr>
      <th>1</th>
      <td>8</td>
      <td>3370</td>
      <td>N06</td>
      <td>2</td>
      <td>SV</td>
      <td>5</td>
      <td>Normal</td>
      <td>54</td>
      <td>1469175885</td>
      <td>2</td>
      <td>81</td>
      <td>N02</td>
      <td>2016-07-22 04:24:45</td>
      <td>2016-07-22_1</td>
      <td>2016-07-22 04:24:45</td>
      <td>2016-07-22</td>
      <td>04:24:45</td>
    </tr>
    <tr>
      <th>2</th>
      <td>8</td>
      <td>3359</td>
      <td>N06</td>
      <td>2</td>
      <td>SV</td>
      <td>0</td>
      <td>Normal</td>
      <td>54</td>
      <td>1469175970</td>
      <td>2</td>
      <td>70</td>
      <td>N03</td>
      <td>2016-07-22 04:24:45</td>
      <td>2016-07-22_1</td>
      <td>2016-07-22 04:26:10</td>
      <td>2016-07-22</td>
      <td>04:26:10</td>
    </tr>
    <tr>
      <th>3</th>
      <td>8</td>
      <td>3352</td>
      <td>N06</td>
      <td>2</td>
      <td>SV</td>
      <td>5</td>
      <td>Normal</td>
      <td>54</td>
      <td>1469176050</td>
      <td>2</td>
      <td>63</td>
      <td>N04</td>
      <td>2016-07-22 04:24:45</td>
      <td>2016-07-22_1</td>
      <td>2016-07-22 04:27:30</td>
      <td>2016-07-22</td>
      <td>04:27:30</td>
    </tr>
    <tr>
      <th>4</th>
      <td>8</td>
      <td>1148</td>
      <td>C15</td>
      <td>2</td>
      <td>YL</td>
      <td>30</td>
      <td>Normal</td>
      <td>66</td>
      <td>1469176365</td>
      <td>2</td>
      <td>12</td>
      <td>C14</td>
      <td>2016-07-22 04:32:45</td>
      <td>2016-07-22_2</td>
      <td>2016-07-22 04:32:45</td>
      <td>2016-07-22</td>
      <td>04:32:45</td>
    </tr>
  </tbody>
</table>
</div>

### Use the data
The first thing I wanted to do was to be able to graphically display the trip information, because that was information that I know had.
After looking at a few different ones, I settled on the red line on August 9th.

[![red_line trips plot]({filename}images/RD_2016-08-09.png)]({filename}images/RD_2016-08-09.png)

As you can see, the red line between Shady Grove and Twin Brook was kind of fucked that day.
You'll also note the lower density of the lines in the middle of the day.
This corresponds to the increased headways during the non rush hours.
The other lines that day looked pretty much ok. You can find them [here.](/blog/metro-math/images/)
You might notice some lines appearing or disappearing.
This could be a problem with my method of generating trip IDs or related to the fact that trains can go into or out of service in the middle of a line.

We can also, like Erik, plot the distribution of headways and the distribution of wait times.

[//]: # ([![blue line headway distribution]({filename}images/BL_headways.png)]({filename}images/BL_headways.png))
[//]: # ([![blue line wait times distribution]({filename}images/BL_wait_times.png)]({filename}images/BL_wait_times.png))


<div class="container-fluid">
<div class="row">
<div class="col-md-12 thumb">
<a href="{filename}images/BL_headways.png" ><img class="img-responsive center-block" src="{filename}images/BL_headways.png"></img></a>

</div>
<div class="col-md-12 thumb">
<a href="{filename}images/BL_wait_times.png" ><img class="img-responsive center-block" src="{filename}images/BL_wait_times.png"></img></a>
</div>
</div>
</div>

Here I've looked at trip times between 7am and 7pm.
And keep in mind that in some cases there may be several lines that work for you.
This isn't accounted for here â€“ I've assumed that you're waiting for a train on particular line in a particulr direction.
This also ignores the fact that not all trains cover the whole line. 
That would be relatively easy to do though by just sorting the trips by destination station.
Again, the plots for the other lines are [here](/blog/metro-math/images/) if you're curious.


The violin plots work better as a comparison mechanism though.

<div class="container-fluid">
<div class="row">
<div class="col-md-12 thumb">
<a href="{filename}images/wait_times.png" ><img class="img-responsive center-block" src="{filename}images/wait_times.png"></img></a>

At this scale, most of the lines look pretty similar in terms of their wait times, so let's zoom in to get a good look.

<div class="container-fluid">
<div class="row">
<div class="col-md-12 thumb">
<a href="{filename}images/wait_times_15max.png" ><img class="img-responsive center-block" src="{filename}images/wait_times_15max.png"></img></a>

From these plots we can gather the the red and the green lines have the worst waiting times in general, but with means around only 2 minutes.
That's not so bad at all! Good job WMATA.

<br>
<br>
The headways are shorter during rush hour times during the week, so we should expect to see some variability in waiting times throughout the day. 
We should also expect to not see such a pattern during the weekend, since the trains should run with consistent headways throughout the day.
Indeed this is what we find.
We can look, for example, at the red line during the week and weekend.
The x-axes have different ranges because the trains run during different hours depending on if it is a weekday or weekend.


<div class="container-fluid">
<div class="row">
<div class="col-md-12 thumb">
<a href="{filename}images/RD_weekday_waiting_by_time.png" ><img class="img-responsive center-block" src="{filename}images/RD_weekday_waiting_by_time.png"></img></a>

</div>
<div class="col-md-12 thumb">
<a href="{filename}images/RD_weekend_waiting_by_time.png" ><img class="img-responsive center-block" src="{filename}images/RD_weekend_waiting_by_time.png"></img></a>
</div>
</div>
</div>

I'm not sure why the wait times increase early in the morning and late at night on the red line during the weekend.
Maybe someone more familiar with the system can account for this.
There are, again, more images for the other lines [here.](/blog/metro-math/images/)

Now we can investigate how much longer you'll have to wait given that you've already waited a certain amount of time.
I've pooled all the lines together for this because there still isn't a ton of data and this process slims it a bit.


<div class="container-fluid">
<div class="row">
<div class="col-md-12 thumb">
<a href="{filename}images/additional_waiting_time.png" ><img class="img-responsive center-block" src="{filename}images/additional_waiting_time.png"></img></a>
</div>
</div>
</div>

This really doesn't look as bad as the NYC plot from the previosuly linked blog post. 
The additional waiting time is pretty consistent all the way up until around 30 minutes.
If your train hasn't come for 30 minutes, you *may* be in for a much longer wait.
However, most of the time, your train will be there within the next few minutes, so it's probably best to continue waiting.

There are surely many more things to look at, but this might be it for now.
Let me know if you have any ideas.

Code available on [github.](https://github.com/kwkelly/notebooks/tree/master/wmata)
